# WebQXâ„¢ EMR Apache Global Configuration

# Security Settings
ServerTokens Prod
ServerSignature Off

# Server Configuration
Timeout 300
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# MPM Configuration
<IfModule mod_mpm_prefork.c>
    StartServers 8
    MinSpareServers 5
    MaxSpareServers 20
    MaxRequestWorkers 256
    MaxConnectionsPerChild 0
</IfModule>

<IfModule mod_mpm_worker.c>
    StartServers 3
    MinSpareThreads 75
    MaxSpareThreads 250
    ThreadsPerChild 25
    MaxRequestWorkers 400
    MaxConnectionsPerChild 0
</IfModule>

<IfModule mod_mpm_event.c>
    StartServers 3
    MinSpareThreads 75
    MaxSpareThreads 250
    ThreadsPerChild 25
    MaxRequestWorkers 400
    MaxConnectionsPerChild 0
</IfModule>

# Access filename
AccessFileName .htaccess

# Security: Prevent access to .htaccess files
<FilesMatch "^\.ht">
    Require all denied
</FilesMatch>

# Security: Prevent access to sensitive files
<FilesMatch "\.(env|log|bak|backup|sql|dump)$">
    Require all denied
</FilesMatch>

# Default file types
<IfModule mod_dir.c>
    DirectoryIndex index.php index.html index.htm
</IfModule>

# MIME types
<IfModule mod_mime.c>
    TypesConfig /etc/mime.types
    
    # WebQX specific MIME types
    AddType application/x-httpd-php .php
    AddType application/x-httpd-php-source .phps
    AddType application/json .json
    AddType application/xml .xml
    AddType text/css .css
    AddType application/javascript .js
    
    # Medical file types
    AddType application/dicom .dcm
    AddType application/hl7-v2 .hl7
    AddType application/fhir+json .fhir
    AddType application/cda+xml .cda
</IfModule>

# Log Format
LogFormat "%v:%p %h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" vhost_combined
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined
LogFormat "%h %l %u %t \"%r\" %>s %O" common
LogFormat "%{Referer}i -> %U" referer
LogFormat "%{User-agent}i" agent

# Error Log
ErrorLog ${APACHE_LOG_DIR}/error.log
LogLevel warn

# Include module configurations
IncludeOptional mods-enabled/*.load
IncludeOptional mods-enabled/*.conf

# Include port configuration
Include ports.conf

# Security Headers Module
<IfModule mod_headers.c>
    # Remove server information
    Header unset Server
    Header unset X-Powered-By
    
    # Security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # HSTS for HTTPS
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" env=HTTPS
</IfModule>

# Compression
<IfModule mod_deflate.c>
    SetOutputFilter DEFLATE
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE application/json
    
    # Don't compress images
    SetEnvIfNoCase Request_URI \
        \.(?:gif|jpe?g|png|ico)$ no-gzip dont-vary
</IfModule>

# Expires headers
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
    ExpiresDefault "access plus 2 days"
</IfModule>

# PHP Configuration
<IfModule mod_php.c>
    php_admin_value memory_limit 512M
    php_admin_value max_execution_time 300
    php_admin_value max_input_time 300
    php_admin_value upload_max_filesize 100M
    php_admin_value post_max_size 100M
    php_admin_value session.gc_maxlifetime 28800
    php_admin_value session.cookie_httponly 1
    php_admin_value expose_php Off
    php_admin_value allow_url_fopen On
    php_admin_value allow_url_include Off
    php_admin_value display_errors Off
    php_admin_value log_errors On
    php_admin_value error_log /var/log/webqx/php_errors.log
</IfModule>

# Include site configurations
IncludeOptional sites-enabled/*.conf
