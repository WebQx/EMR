<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebQX Ottehr-Keycloak SSO Demo</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #2c5aa0;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            margin-bottom: 20px;
        }
        .auth-section {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 20px;
            margin: 20px 0;
        }
        .auth-section h3 {
            margin-top: 0;
            color: #333;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .btn {
            background-color: #2c5aa0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover {
            background-color: #1a4480;
        }
        .btn.secondary {
            background-color: #6c757d;
        }
        .btn.secondary:hover {
            background-color: #545b62;
        }
        .btn.danger {
            background-color: #dc3545;
        }
        .btn.danger:hover {
            background-color: #c82333;
        }
        .user-info {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .roles {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .role-badge {
            background-color: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .hidden {
            display: none;
        }
        .code-block {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
            overflow-x: auto;
        }
        .config-section {
            margin-top: 30px;
            border-top: 2px solid #e0e0e0;
            padding-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üè• WebQX Healthcare Platform</div>
            <div class="subtitle">Ottehr-Keycloak SSO Integration Demo</div>
        </div>

        <!-- Authentication Status -->
        <div class="auth-section">
            <h3>üîê Authentication Status</h3>
            <div id="auth-status" class="status info">
                Checking authentication status...
            </div>
            
            <!-- Not Authenticated View -->
            <div id="not-authenticated" class="hidden">
                <p>You are not currently authenticated. Choose a login method:</p>
                <button id="login-keycloak" class="btn">üîë Login with Keycloak SSO</button>
                <button id="login-api-key" class="btn secondary">üîì Login with API Key</button>
                <button id="login-oauth" class="btn secondary">‚ö° Login with OAuth2</button>
            </div>

            <!-- Authenticated View -->
            <div id="authenticated" class="hidden">
                <div class="user-info">
                    <h4>üë§ User Information</h4>
                    <div id="user-details"></div>
                    <div class="roles">
                        <strong>Roles:</strong>
                        <div id="user-roles"></div>
                    </div>
                </div>
                <button id="refresh-token" class="btn secondary">üîÑ Refresh Token</button>
                <button id="get-user-info" class="btn secondary">üë§ Get User Info</button>
                <button id="logout" class="btn danger">üö™ Logout</button>
            </div>
        </div>

        <!-- API Testing -->
        <div class="auth-section">
            <h3>üß™ API Testing</h3>
            <p>Test Ottehr API endpoints with your authentication:</p>
            <button id="test-orders" class="btn">üì¶ Test Orders API</button>
            <button id="test-notifications" class="btn">üìß Test Notifications API</button>
            <button id="test-delivery" class="btn">üöö Test Delivery API</button>
            
            <div id="api-results" class="code-block hidden">
                <strong>API Response:</strong>
                <pre id="api-output"></pre>
            </div>
        </div>

        <!-- Role-Based Access Demo -->
        <div class="auth-section">
            <h3>üîí Role-Based Access Control Demo</h3>
            <p>Test access to different features based on your roles:</p>
            <button id="test-admin" class="btn">üëë Admin Features</button>
            <button id="test-pharmacy" class="btn">üíä Pharmacy Features</button>
            <button id="test-delivery-role" class="btn">üöö Delivery Features</button>
            
            <div id="role-results"></div>
        </div>

        <!-- Configuration -->
        <div class="config-section">
            <h3>‚öôÔ∏è Configuration</h3>
            <p>Current integration configuration:</p>
            <div class="code-block">
                <div id="config-display">Loading configuration...</div>
            </div>
            
            <details>
                <summary><strong>üìã Setup Instructions</strong></summary>
                <div style="margin-top: 15px;">
                    <h4>1. Environment Variables</h4>
                    <div class="code-block">
# Keycloak Configuration
KEYCLOAK_ENABLED=true
KEYCLOAK_BASE_URL=https://your-keycloak-server.com
KEYCLOAK_REALM=webqx-healthcare
KEYCLOAK_CLIENT_ID=ottehr-integration
KEYCLOAK_CLIENT_SECRET=your-client-secret
KEYCLOAK_REDIRECT_URI=http://localhost:3000/ottehr-keycloak-demo.html

# Ottehr Configuration  
OTTEHR_API_BASE_URL=https://api.ottehr.com
OTTEHR_CLIENT_ID=your-ottehr-client
OTTEHR_CLIENT_SECRET=your-ottehr-secret
                    </div>
                    
                    <h4>2. Keycloak Setup</h4>
                    <p>Import the realm configuration from <code>auth/ottehr/config/keycloak-realm.json</code></p>
                    
                    <h4>3. Usage</h4>
                    <div class="code-block">
import { webqxLogin } from './auth/webqx-login-manager';

// Listen for authentication events
webqxLogin.on('userAuthenticated', (data) => {
    console.log('User logged in:', data.user);
});

// Initiate SSO login
await webqxLogin.loginWithKeycloak('/dashboard');

// Check roles
if (webqxLogin.hasRole('ottehr-admin')) {
    // Show admin features
}
                    </div>
                </div>
            </details>
        </div>
    </div>

    <script type="module">
        // Mock implementation for demo purposes
        // In a real application, you would import the actual WebQX Login Manager
        
        class MockWebQXLoginManager {
            constructor() {
                this.isAuth = false;
                this.user = null;
                this.roles = [];
                this.setupMockData();
            }
            
            setupMockData() {
                // Check if we're in a callback scenario
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('code')) {
                    this.handleMockCallback();
                }
            }
            
            async handleMockCallback() {
                // Simulate successful authentication
                this.isAuth = true;
                this.user = {
                    sub: 'user-123',
                    email: 'demo@webqx.health',
                    preferred_username: 'demo-user',
                    given_name: 'Demo',
                    family_name: 'User',
                    name: 'Demo User'
                };
                this.roles = ['ottehr-user', 'ottehr-pharmacy'];
                this.updateUI();
                
                // Clear URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            
            loginWithKeycloak() {
                // Simulate redirect to Keycloak
                const params = new URLSearchParams({
                    code: 'mock-auth-code',
                    state: 'mock-state'
                });
                window.location.href = `${window.location.pathname}?${params.toString()}`;
            }
            
            loginWithApiKey() {
                // Simulate API key authentication
                this.isAuth = true;
                this.user = {
                    sub: 'api-user-456',
                    preferred_username: 'api-user',
                    name: 'API User'
                };
                this.roles = ['ottehr-user'];
                this.updateUI();
            }
            
            loginWithOAuth() {
                // Simulate OAuth2 authentication
                this.isAuth = true;
                this.user = {
                    sub: 'oauth-user-789',
                    preferred_username: 'oauth-user',
                    name: 'OAuth User'
                };
                this.roles = ['ottehr-user', 'ottehr-delivery'];
                this.updateUI();
            }
            
            logout() {
                this.isAuth = false;
                this.user = null;
                this.roles = [];
                this.updateUI();
            }
            
            isAuthenticated() {
                return this.isAuth;
            }
            
            getCurrentUser() {
                return this.user;
            }
            
            getUserRoles() {
                return this.roles;
            }
            
            hasRole(role) {
                return this.roles.includes(role);
            }
            
            async mockApiCall(endpoint) {
                if (!this.isAuth) {
                    throw new Error('Not authenticated');
                }
                
                // Simulate API responses
                const responses = {
                    orders: { success: true, data: [{ id: '123', status: 'pending', items: 3 }] },
                    notifications: { success: true, data: [{ id: '456', type: 'order_update', sent: true }] },
                    delivery: { success: true, data: [{ id: '789', status: 'in_transit', eta: '15 minutes' }] }
                };
                
                return responses[endpoint] || { success: false, error: 'Unknown endpoint' };
            }
            
            updateUI() {
                const authStatus = document.getElementById('auth-status');
                const notAuth = document.getElementById('not-authenticated');
                const auth = document.getElementById('authenticated');
                const userDetails = document.getElementById('user-details');
                const userRoles = document.getElementById('user-roles');
                
                if (this.isAuth) {
                    authStatus.className = 'status success';
                    authStatus.textContent = '‚úÖ Authenticated successfully';
                    notAuth.classList.add('hidden');
                    auth.classList.remove('hidden');
                    
                    userDetails.innerHTML = `
                        <div><strong>Name:</strong> ${this.user.name || 'N/A'}</div>
                        <div><strong>Email:</strong> ${this.user.email || 'N/A'}</div>
                        <div><strong>Username:</strong> ${this.user.preferred_username || 'N/A'}</div>
                        <div><strong>ID:</strong> ${this.user.sub || 'N/A'}</div>
                    `;
                    
                    userRoles.innerHTML = this.roles.map(role => 
                        `<span class="role-badge">${role}</span>`
                    ).join('');
                } else {
                    authStatus.className = 'status info';
                    authStatus.textContent = 'üîí Not authenticated';
                    notAuth.classList.remove('hidden');
                    auth.classList.add('hidden');
                }
                
                this.updateConfig();
            }
            
            updateConfig() {
                const configDisplay = document.getElementById('config-display');
                configDisplay.innerHTML = `
Keycloak Enabled: ${this.isAuth ? 'Yes' : 'No'}<br>
Base URL: https://keycloak.demo.webqx.health<br>
Realm: webqx-healthcare<br>
Client ID: ottehr-integration<br>
Authentication Status: ${this.isAuth ? 'Authenticated' : 'Not Authenticated'}<br>
Current User: ${this.user ? this.user.preferred_username : 'None'}<br>
Active Roles: ${this.roles.join(', ') || 'None'}
                `;
            }
        }
        
        // Initialize the demo
        const webqxLogin = new MockWebQXLoginManager();
        
        // Event listeners
        document.getElementById('login-keycloak').addEventListener('click', () => {
            webqxLogin.loginWithKeycloak();
        });
        
        document.getElementById('login-api-key').addEventListener('click', () => {
            webqxLogin.loginWithApiKey();
        });
        
        document.getElementById('login-oauth').addEventListener('click', () => {
            webqxLogin.loginWithOAuth();
        });
        
        document.getElementById('logout').addEventListener('click', () => {
            webqxLogin.logout();
        });
        
        document.getElementById('refresh-token').addEventListener('click', () => {
            const status = document.getElementById('auth-status');
            status.className = 'status success';
            status.textContent = 'üîÑ Token refreshed successfully';
        });
        
        document.getElementById('get-user-info').addEventListener('click', async () => {
            const status = document.getElementById('auth-status');
            status.className = 'status success';
            status.textContent = 'üë§ User info refreshed from Keycloak';
        });
        
        // API Testing
        ['orders', 'notifications', 'delivery'].forEach(endpoint => {
            document.getElementById(`test-${endpoint === 'delivery' ? 'delivery' : endpoint}`).addEventListener('click', async () => {
                try {
                    const result = await webqxLogin.mockApiCall(endpoint);
                    const apiResults = document.getElementById('api-results');
                    const apiOutput = document.getElementById('api-output');
                    
                    apiResults.classList.remove('hidden');
                    apiOutput.textContent = JSON.stringify(result, null, 2);
                } catch (error) {
                    const apiResults = document.getElementById('api-results');
                    const apiOutput = document.getElementById('api-output');
                    
                    apiResults.classList.remove('hidden');
                    apiOutput.textContent = `Error: ${error.message}`;
                }
            });
        });
        
        // Role-based access testing
        document.getElementById('test-admin').addEventListener('click', () => {
            const results = document.getElementById('role-results');
            const hasRole = webqxLogin.hasRole('ottehr-admin');
            results.innerHTML = `
                <div class="status ${hasRole ? 'success' : 'error'}">
                    ${hasRole ? '‚úÖ Access granted to admin features' : '‚ùå Access denied - Admin role required'}
                </div>
            `;
        });
        
        document.getElementById('test-pharmacy').addEventListener('click', () => {
            const results = document.getElementById('role-results');
            const hasRole = webqxLogin.hasRole('ottehr-pharmacy') || webqxLogin.hasRole('ottehr-admin');
            results.innerHTML = `
                <div class="status ${hasRole ? 'success' : 'error'}">
                    ${hasRole ? '‚úÖ Access granted to pharmacy features' : '‚ùå Access denied - Pharmacy role required'}
                </div>
            `;
        });
        
        document.getElementById('test-delivery-role').addEventListener('click', () => {
            const results = document.getElementById('role-results');
            const hasRole = webqxLogin.hasRole('ottehr-delivery') || webqxLogin.hasRole('ottehr-admin');
            results.innerHTML = `
                <div class="status ${hasRole ? 'success' : 'error'}">
                    ${hasRole ? '‚úÖ Access granted to delivery features' : '‚ùå Access denied - Delivery role required'}
                </div>
            `;
        });
        
        // Initialize UI
        webqxLogin.updateUI();
    </script>
</body>
</html>