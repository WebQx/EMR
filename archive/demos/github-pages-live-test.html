<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitHub Pages Integration Test - Fresh</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { padding: 15px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ GitHub Pages Integration Test - Live Version</h1>
        <p><strong>Testing the actual GitHub Pages integration right now...</strong></p>
        
        <div id="status" class="status info">üîÑ Initializing test...</div>
        
        <div>
            <button onclick="testLiveIntegration()">üåê Test Live GitHub Pages</button>
            <button onclick="testDirectAPI()">üöÄ Test Direct API</button>
            <button onclick="testCacheBypass()">üîÑ Test Cache Bypass</button>
            <button onclick="clearLog()">üßπ Clear Log</button>
        </div>
        
        <div id="log" class="log"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        async function testLiveIntegration() {
            log('=== Testing Live GitHub Pages Integration ===');
            updateStatus('üß™ Testing live integration...', 'info');
            
            try {
                // First, check if the new integration script is accessible
                const scriptUrl = 'https://webqx.github.io/webqx/github-pages-integration-patch.js';
                log(`Fetching integration script: ${scriptUrl}`);
                
                const scriptResponse = await fetch(scriptUrl + '?v=' + Date.now(), {
                    method: 'GET',
                    cache: 'no-cache'
                });
                
                if (scriptResponse.ok) {
                    const scriptContent = await scriptResponse.text();
                    
                    if (scriptContent.includes('IMMEDIATE OVERRIDE VERSION')) {
                        log('‚úÖ New enhanced integration script is live', 'success');
                        
                        // Check the main page
                        const pageResponse = await fetch('https://webqx.github.io/webqx/', {
                            method: 'GET',
                            cache: 'no-cache'
                        });
                        
                        if (pageResponse.ok) {
                            const pageContent = await pageResponse.text();
                            
                            if (pageContent.includes('github-pages-integration-patch.js')) {
                                log('‚úÖ Main page includes integration script', 'success');
                                updateStatus('‚úÖ GitHub Pages integration is properly deployed', 'success');
                                
                                // Test if we can execute the enhanced functions
                                log('Testing enhanced function behavior...');
                                
                                // Simulate what the enhanced script would do
                                await testEnhancedBehavior();
                                
                            } else {
                                log('‚ùå Main page missing integration script reference', 'error');
                                updateStatus('‚ùå Integration script not included in page', 'error');
                            }
                        } else {
                            log('‚ùå Cannot fetch main GitHub Pages content', 'error');
                        }
                        
                    } else {
                        log('‚ùå Old integration script still cached', 'error');
                        updateStatus('‚ùå GitHub Pages showing cached version', 'error');
                    }
                } else {
                    log(`‚ùå Cannot fetch integration script: ${scriptResponse.status}`, 'error');
                    updateStatus('‚ùå Integration script not accessible', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Live integration test failed: ${error.message}`, 'error');
                updateStatus('‚ùå Integration test failed', 'error');
            }
        }
        
        async function testEnhancedBehavior() {
            log('--- Testing Enhanced Behavior ---');
            
            // Test the same logic our enhanced script uses
            const serverUrl = '192.168.173.251:8080';
            
            try {
                log(`Testing OPTIONS request to ${serverUrl}...`);
                
                const optionsResponse = await fetch(`http://${serverUrl}/api/remote-start`, {
                    method: 'OPTIONS',
                    mode: 'cors'
                });
                
                if (optionsResponse.ok || optionsResponse.status === 204) {
                    log('‚úÖ OPTIONS request successful - server should show green', 'success');
                    log('üìä This means the enhanced script should detect server as online', 'success');
                } else {
                    log(`‚ö†Ô∏è OPTIONS request returned: ${optionsResponse.status}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Enhanced behavior test failed: ${error.message}`, 'error');
                log('üí° This might be why GitHub Pages shows red - network/CORS issue', 'info');
            }
        }
        
        async function testDirectAPI() {
            log('=== Testing Direct API Access ===');
            
            const serverUrl = '192.168.173.251:8080';
            
            try {
                log(`Testing direct POST to ${serverUrl}...`);
                
                const response = await fetch(`http://${serverUrl}/api/remote-start`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'start',
                        source: 'live-test',
                        timestamp: new Date().toISOString()
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Direct API test successful: ${result.message}`, 'success');
                    updateStatus('‚úÖ API is working - issue might be browser cache', 'success');
                } else {
                    log(`‚ùå Direct API test failed: ${response.status}`, 'error');
                }
                
            } catch (error) {
                log(`‚ùå Direct API test error: ${error.message}`, 'error');
                updateStatus('‚ùå Cannot reach API from browser', 'error');
            }
        }
        
        async function testCacheBypass() {
            log('=== Testing Cache Bypass Methods ===');
            
            const testUrls = [
                'https://webqx.github.io/webqx/?v=' + Date.now(),
                'https://webqx.github.io/webqx/github-pages-integration-patch.js?v=' + Date.now()
            ];
            
            for (const url of testUrls) {
                try {
                    log(`Testing cache bypass: ${url}`);
                    
                    const response = await fetch(url, {
                        method: 'HEAD',
                        cache: 'no-cache',
                        headers: {
                            'Cache-Control': 'no-cache',
                            'Pragma': 'no-cache'
                        }
                    });
                    
                    if (response.ok) {
                        const lastModified = response.headers.get('last-modified');
                        log(`‚úÖ Cache bypass successful, last-modified: ${lastModified}`, 'success');
                    } else {
                        log(`‚ùå Cache bypass failed: ${response.status}`, 'error');
                    }
                    
                } catch (error) {
                    log(`‚ùå Cache bypass error: ${error.message}`, 'error');
                }
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
            log('Log cleared');
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            log('üåü GitHub Pages Integration Live Test initialized');
            log('üéØ This tests the actual live GitHub Pages integration');
            log('');
            updateStatus('Ready to test live integration', 'info');
        });
    </script>
</body>
</html>