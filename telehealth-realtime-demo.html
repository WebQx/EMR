<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebQX‚Ñ¢ Real-Time Telehealth Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .video-feed {
            background: linear-gradient(45deg, #1a1a2e, #16213e);
            position: relative;
            overflow: hidden;
        }
        
        .video-feed::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse at center, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, transparent 100%);
            animation: videoNoise 2s infinite;
        }
        
        @keyframes videoNoise {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }
        
        .vital-sign {
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .recording-indicator {
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.3; }
        }
        
        .waveform {
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .wave-bar {
            width: 3px;
            background: #10b981;
            border-radius: 2px;
            animation: wave 1.5s ease-in-out infinite;
        }
        
        .wave-bar:nth-child(1) { height: 10px; animation-delay: 0s; }
        .wave-bar:nth-child(2) { height: 20px; animation-delay: 0.1s; }
        .wave-bar:nth-child(3) { height: 15px; animation-delay: 0.2s; }
        .wave-bar:nth-child(4) { height: 25px; animation-delay: 0.3s; }
        .wave-bar:nth-child(5) { height: 18px; animation-delay: 0.4s; }
        .wave-bar:nth-child(6) { height: 12px; animation-delay: 0.5s; }
        .wave-bar:nth-child(7) { height: 22px; animation-delay: 0.6s; }
        .wave-bar:nth-child(8) { height: 16px; animation-delay: 0.7s; }
        
        @keyframes wave {
            0%, 100% { height: 10px; opacity: 0.5; }
            50% { height: 100%; opacity: 1; }
        }
        
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 10px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #6b7280;
            border-radius: 50%;
            animation: typing 1.4s ease-in-out infinite;
        }
        
        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <h1 class="text-white text-xl font-bold">üé• WebQX‚Ñ¢ Real-Time Telehealth</h1>
                <div class="flex items-center space-x-2 bg-red-600 px-3 py-1 rounded-full recording-indicator">
                    <div class="w-2 h-2 bg-white rounded-full"></div>
                    <span class="text-white text-sm font-medium">LIVE SESSION</span>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <!-- Session Timer -->
                <div class="text-green-400 font-mono" id="sessionTimer">00:00:00</div>
                
                <!-- View Toggle -->
                <select id="viewMode" class="bg-gray-700 text-white px-3 py-1 rounded" onchange="changeViewMode()">
                    <option value="dual">Dual View</option>
                    <option value="provider">Provider View</option>
                    <option value="patient">Patient View</option>
                </select>
                
                <!-- End Session -->
                <button onclick="endSession()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg">
                    End Session
                </button>
            </div>
        </div>
    </header>

    <!-- Main Video Interface -->
    <div class="flex-1 p-6" id="mainInterface">
        <!-- Dual View Mode -->
        <div id="dualView" class="grid grid-cols-2 gap-6 h-full">
            <!-- Provider Side -->
            <div class="bg-gray-800 rounded-xl overflow-hidden">
                <div class="bg-blue-900 px-4 py-2 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-semibold">DR</span>
                        </div>
                        <div>
                            <h3 class="text-white font-semibold">Dr. Sarah Johnson</h3>
                            <p class="text-blue-200 text-sm">Internal Medicine</p>
                        </div>
                    </div>
                    <div class="text-green-400 text-sm">üü¢ Online</div>
                </div>
                
                <!-- Provider Video Feed -->
                <div class="video-feed h-64 relative">
                    <video id="providerVideoElement" class="absolute inset-0 w-full h-full object-cover rounded-lg" autoplay muted style="display: none;"></video>
                    <div id="providerVideoPlaceholder" class="absolute inset-4 bg-blue-600 bg-opacity-20 rounded-lg flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-blue-600 rounded-full mx-auto mb-2 flex items-center justify-center">
                                <span class="text-white text-lg">üë©‚Äç‚öïÔ∏è</span>
                            </div>
                            <p class="text-white font-medium">Dr. Sarah Johnson</p>
                            <p class="text-blue-200 text-sm" id="providerVideoStatus">Click camera to enable video</p>
                        </div>
                    </div>
                    
                    <!-- Audio Waveform -->
                    <div class="absolute bottom-4 left-4 flex items-center space-x-2">
                        <span class="text-white text-sm">üé§</span>
                        <div class="waveform" id="providerAudio" style="display: none;">
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Provider Controls -->
                <div class="p-4 bg-gray-750 border-t border-gray-600">
                    <div class="flex items-center justify-between">
                        <div class="flex space-x-2">
                            <button id="providerMic" onclick="toggleMic('provider')" class="bg-green-600 hover:bg-green-700 p-2 rounded">
                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <button id="providerVideo" onclick="toggleVideo('provider')" class="bg-blue-600 hover:bg-blue-700 p-2 rounded">
                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                                </svg>
                            </button>
                            <button onclick="shareScreen('provider')" class="bg-purple-600 hover:bg-purple-700 p-2 rounded">
                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 011 1v4a1 1 0 01-2 0V5H5v10h4a1 1 0 110 2H4a1 1 0 01-1-1V4zm7.707 4.293a1 1 0 00-1.414 1.414L11 11.414V9a1 1 0 112 0v2.414l1.707-1.707a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="text-white text-sm">Provider Controls</div>
                    </div>
                </div>
            </div>

            <!-- Patient Side -->
            <div class="bg-gray-800 rounded-xl overflow-hidden">
                <div class="bg-green-900 px-4 py-2 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center">
                            <span class="text-white text-sm font-semibold">JD</span>
                        </div>
                        <div>
                            <h3 class="text-white font-semibold">John Doe</h3>
                            <p class="text-green-200 text-sm">Patient ID: P001234</p>
                        </div>
                    </div>
                    <div class="text-green-400 text-sm">üü¢ Connected</div>
                </div>
                
                <!-- Patient Video Feed -->
                <div class="video-feed h-64 relative">
                    <video id="patientVideoElement" class="absolute inset-0 w-full h-full object-cover rounded-lg" autoplay muted style="display: none;"></video>
                    <div id="patientVideoPlaceholder" class="absolute inset-4 bg-green-600 bg-opacity-20 rounded-lg flex items-center justify-center">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-600 rounded-full mx-auto mb-2 flex items-center justify-center">
                                <span class="text-white text-lg">üë®</span>
                            </div>
                            <p class="text-white font-medium">John Doe</p>
                            <p class="text-green-200 text-sm" id="patientVideoStatus">Click camera to enable video</p>
                        </div>
                    </div>
                    
                    <!-- Audio Waveform -->
                    <div class="absolute bottom-4 left-4 flex items-center space-x-2">
                        <span class="text-white text-sm">üé§</span>
                        <div class="waveform" id="patientAudio" style="display: none;">
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                            <div class="wave-bar"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Controls -->
                <div class="p-4 bg-gray-750 border-t border-gray-600">
                    <div class="flex items-center justify-between">
                        <div class="flex space-x-2">
                            <button id="patientMic" onclick="toggleMic('patient')" class="bg-green-600 hover:bg-green-700 p-2 rounded">
                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <button id="patientVideo" onclick="toggleVideo('patient')" class="bg-blue-600 hover:bg-blue-700 p-2 rounded">
                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path>
                                </svg>
                            </button>
                            <button onclick="requestHelp()" class="bg-yellow-600 hover:bg-yellow-700 p-2 rounded">
                                <svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="text-white text-sm">Patient Controls</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Side Panel -->
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Real-Time Chat -->
            <div class="bg-gray-800 rounded-xl overflow-hidden">
                <div class="bg-gray-700 px-4 py-3 flex items-center justify-between">
                    <h3 class="text-white font-semibold">üí¨ Live Chat</h3>
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                        <span class="text-green-400 text-sm">Active</span>
                    </div>
                </div>
                
                <div id="chatMessages" class="p-4 h-64 overflow-y-auto space-y-3">
                    <div class="chat-message">
                        <div class="flex items-start space-x-2">
                            <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-xs text-white">DR</div>
                            <div class="flex-1">
                                <div class="bg-blue-600 text-white p-2 rounded-lg text-sm">
                                    Hello John! How are you feeling today?
                                </div>
                                <div class="text-gray-400 text-xs mt-1">Dr. Johnson ‚Ä¢ 2:30 PM</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-message">
                        <div class="flex items-start space-x-2 flex-row-reverse">
                            <div class="w-6 h-6 bg-green-600 rounded-full flex items-center justify-center text-xs text-white">JD</div>
                            <div class="flex-1">
                                <div class="bg-green-600 text-white p-2 rounded-lg text-sm text-right">
                                    Hi Dr. Johnson! I'm feeling much better today. The medication seems to be working.
                                </div>
                                <div class="text-gray-400 text-xs mt-1 text-right">John ‚Ä¢ 2:31 PM</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="typingIndicator" class="hidden">
                        <div class="flex items-center space-x-2">
                            <div class="w-6 h-6 bg-blue-600 rounded-full flex items-center justify-center text-xs text-white">DR</div>
                            <div class="typing-indicator">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <span class="text-gray-400 text-sm">Dr. Johnson is typing...</span>
                        </div>
                    </div>
                </div>
                
                <div class="border-t border-gray-600 p-4">
                    <div class="flex space-x-2">
                        <input 
                            id="chatInput" 
                            type="text" 
                            placeholder="Type your message..." 
                            class="flex-1 bg-gray-700 text-white px-3 py-2 rounded"
                            onkeypress="handleChatKeypress(event)"
                        >
                        <button onclick="sendMessage()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded text-white">
                            Send
                        </button>
                    </div>
                </div>
            </div>

            <!-- Live Vital Signs -->
            <div class="bg-gray-800 rounded-xl overflow-hidden">
                <div class="bg-gray-700 px-4 py-3">
                    <h3 class="text-white font-semibold">üíì Live Vitals</h3>
                </div>
                
                <div class="p-4 space-y-4">
                    <div class="vital-sign bg-red-900 bg-opacity-30 p-3 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-red-300">Heart Rate</span>
                            <span class="text-red-200 font-mono text-lg" id="heartRate">72 BPM</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                            <div class="bg-red-500 h-2 rounded-full" style="width: 72%"></div>
                        </div>
                    </div>
                    
                    <div class="vital-sign bg-blue-900 bg-opacity-30 p-3 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-blue-300">Blood Pressure</span>
                            <span class="text-blue-200 font-mono text-lg" id="bloodPressure">120/80</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                            <div class="bg-blue-500 h-2 rounded-full" style="width: 65%"></div>
                        </div>
                    </div>
                    
                    <div class="vital-sign bg-green-900 bg-opacity-30 p-3 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-green-300">Oxygen Sat</span>
                            <span class="text-green-200 font-mono text-lg" id="oxygenSat">98%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                            <div class="bg-green-500 h-2 rounded-full" style="width: 98%"></div>
                        </div>
                    </div>
                    
                    <div class="vital-sign bg-yellow-900 bg-opacity-30 p-3 rounded-lg">
                        <div class="flex items-center justify-between">
                            <span class="text-yellow-300">Temperature</span>
                            <span class="text-yellow-200 font-mono text-lg" id="temperature">98.6¬∞F</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mt-2">
                            <div class="bg-yellow-500 h-2 rounded-full" style="width: 55%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Provider Notes -->
            <div class="bg-gray-800 rounded-xl overflow-hidden">
                <div class="bg-gray-700 px-4 py-3 flex items-center justify-between">
                    <h3 class="text-white font-semibold">üìù Live Notes</h3>
                    <button onclick="saveNotes()" class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded text-white text-sm">
                        Save
                    </button>
                </div>
                
                <div class="p-4">
                    <textarea 
                        id="providerNotes" 
                        placeholder="Take real-time notes during consultation..."
                        class="w-full h-48 bg-gray-700 text-white p-3 rounded resize-none"
                        oninput="autoSaveNotes()"
                    >Patient appears alert and responsive.
Vitals stable within normal range.
Reports improvement with current medication.
No immediate concerns noted.

Follow-up in 2 weeks.
</textarea>
                    
                    <div class="mt-3 flex items-center justify-between text-sm">
                        <span class="text-gray-400" id="noteStatus">Auto-saved 5 seconds ago</span>
                        <span class="text-gray-400" id="wordCount">28 words</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shared Screen Area -->
        <div id="sharedScreen" class="mt-6 bg-gray-800 rounded-xl overflow-hidden hidden">
            <div class="bg-purple-900 px-4 py-3 flex items-center justify-between">
                <h3 class="text-white font-semibold">üì∫ Shared Content</h3>
                <button onclick="stopSharing()" class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded text-white text-sm">
                    Stop Sharing
                </button>
            </div>
            
            <div class="p-6 text-center">
                <div class="bg-white rounded-lg p-8 max-w-2xl mx-auto">
                    <h4 class="text-gray-800 text-xl font-bold mb-4">üìä Lab Results - John Doe</h4>
                    <div class="grid grid-cols-2 gap-4 text-left">
                        <div>
                            <strong>Complete Blood Count:</strong>
                            <ul class="mt-2 space-y-1 text-sm">
                                <li>‚Ä¢ WBC: 7,200/ŒºL ‚úÖ</li>
                                <li>‚Ä¢ RBC: 4.8 M/ŒºL ‚úÖ</li>
                                <li>‚Ä¢ Hemoglobin: 14.2 g/dL ‚úÖ</li>
                                <li>‚Ä¢ Platelets: 280,000/ŒºL ‚úÖ</li>
                            </ul>
                        </div>
                        <div>
                            <strong>Basic Metabolic Panel:</strong>
                            <ul class="mt-2 space-y-1 text-sm">
                                <li>‚Ä¢ Glucose: 95 mg/dL ‚úÖ</li>
                                <li>‚Ä¢ Sodium: 140 mEq/L ‚úÖ</li>
                                <li>‚Ä¢ Potassium: 4.2 mEq/L ‚úÖ</li>
                                <li>‚Ä¢ Creatinine: 0.9 mg/dL ‚úÖ</li>
                            </ul>
                        </div>
                    </div>
                    <div class="mt-4 p-3 bg-green-100 rounded">
                        <strong class="text-green-800">All values within normal range</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Session management
        let sessionStartTime = Date.now();
        let sessionTimer;
        let isRecording = true;
        let chatHistory = [];
        let vitalsInterval;
        
        // Media streams for real camera/audio functionality
        let currentVideoStream = null;
        let currentAudioStream = null;
        let audioContext = null;
        let analyser = null;
        let animationFrame = null;

        // Initialize session
        document.addEventListener('DOMContentLoaded', function() {
            startSessionTimer();
            startVitalsSimulation();
            simulateRealtimeActivity();
        });

        function startSessionTimer() {
            sessionTimer = setInterval(() => {
                const elapsed = Date.now() - sessionStartTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('sessionTimer').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function startVitalsSimulation() {
            vitalsInterval = setInterval(() => {
                // Simulate realistic vital sign fluctuations
                const heartRate = 70 + Math.floor(Math.random() * 10);
                const systolic = 118 + Math.floor(Math.random() * 8);
                const diastolic = 78 + Math.floor(Math.random() * 6);
                const oxygenSat = 97 + Math.floor(Math.random() * 3);
                const temp = 98.4 + (Math.random() * 0.6);

                document.getElementById('heartRate').textContent = `${heartRate} BPM`;
                document.getElementById('bloodPressure').textContent = `${systolic}/${diastolic}`;
                document.getElementById('oxygenSat').textContent = `${oxygenSat}%`;
                document.getElementById('temperature').textContent = `${temp.toFixed(1)}¬∞F`;
            }, 3000);
        }

        function simulateRealtimeActivity() {
            // Simulate random chat messages
            setTimeout(() => {
                addChatMessage('provider', "Let's review your lab results together.", 'Dr. Johnson');
                
                setTimeout(() => {
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        addChatMessage('patient', "Thank you, I'm ready to see them.", 'John');
                    }, 2000);
                }, 3000);
            }, 10000);
        }

        // Audio analysis functions for real microphone input
        function startAudioAnalysis(stream, waveformId) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaStreamSource(stream);
            
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            
            source.connect(analyser);
            
            function animate() {
                analyser.getByteFrequencyData(dataArray);
                updateWaveform(dataArray, waveformId);
                animationFrame = requestAnimationFrame(animate);
            }
            animate();
        }
        
        function updateWaveform(dataArray, waveformId) {
            const waveform = document.getElementById(waveformId);
            if (!waveform) return;
            
            const bars = waveform.querySelectorAll('.bar');
            bars.forEach((bar, index) => {
                if (index < dataArray.length / 4) {
                    const height = (dataArray[index] / 255) * 100;
                    bar.style.height = `${Math.max(height, 10)}%`;
                }
            });
        }
        
        function stopAudioAnalysis() {
            if (animationFrame) {
                cancelAnimationFrame(animationFrame);
                animationFrame = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
        }

        function changeViewMode() {
            const mode = document.getElementById('viewMode').value;
            const dualView = document.getElementById('dualView');
            
            // For demo purposes, just show dual view
            // In real implementation, you'd switch between different layouts
            console.log(`Switched to ${mode} view`);
        }

        async function toggleMic(user) {
            const button = document.getElementById(`${user}Mic`);
            const isActive = button.classList.contains('bg-green-600');
            
            if (isActive) {
                button.classList.remove('bg-green-600', 'hover:bg-green-700');
                button.classList.add('bg-red-600', 'hover:bg-red-700');
                button.innerHTML = `<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414 1.414L6.524 7.937A6 6 0 0018 10h2a8 8 0 00-13.364-5.958l-1.414-1.414a1 1 0 00-1.414 1.414l14.142 14.142a1 1 0 001.414-1.414z" clip-rule="evenodd"></path></svg>`;
                
                // Stop audio stream and waveform
                if (currentAudioStream && user === 'patient') {
                    currentAudioStream.getTracks().forEach(track => track.stop());
                    currentAudioStream = null;
                    stopAudioAnalysis();
                }
                document.getElementById(`${user}Audio`).style.display = 'none';
            } else {
                button.classList.remove('bg-red-600', 'hover:bg-red-700');
                button.classList.add('bg-green-600', 'hover:bg-green-700');
                button.innerHTML = `<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7 4a3 3 0 016 0v4a3 3 0 11-6 0V4zm4 10.93A7.001 7.001 0 0017 8a1 1 0 10-2 0A5 5 0 015 8a1 1 0 00-2 0 7.001 7.001 0 006 6.93V17H6a1 1 0 100 2h8a1 1 0 100-2h-3v-2.07z" clip-rule="evenodd"></path></svg>`;
                
                // Start audio stream for patient only (real microphone)
                if (user === 'patient') {
                    try {
                        currentAudioStream = await navigator.mediaDevices.getUserMedia({ 
                            video: false, 
                            audio: true 
                        });
                        startAudioAnalysis(currentAudioStream, `${user}Audio`);
                        document.getElementById(`${user}Audio`).style.display = 'flex';
                    } catch (error) {
                        console.error('Error accessing microphone:', error);
                        addChatMessage('system', 'Could not access microphone. Please check permissions.', 'System');
                        // Revert button state
                        button.classList.add('bg-red-600', 'hover:bg-red-700');
                        button.classList.remove('bg-green-600', 'hover:bg-green-700');
                        button.innerHTML = `<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M13.477 14.89A6 6 0 715.11 6.524l8.367 8.368zm1.414 1.414L6.524 7.937A6 6 0 0018 10h2a8 8 0 00-13.364-5.958l-1.414-1.414a1 1 0 00-1.414 1.414l14.142 14.142a1 1 0 001.414-1.414z" clip-rule="evenodd"></path></svg>`;
                    }
                } else {
                    // For provider, just show simulated waveform
                    document.getElementById(`${user}Audio`).style.display = 'flex';
                }
            }
        }

        async function toggleVideo(user) {
            const button = document.getElementById(`${user}Video`);
            const isActive = button.classList.contains('bg-blue-600');
            const videoElement = document.getElementById(user === 'provider' ? 'providerVideoElement' : 'patientVideoElement');
            
            if (isActive) {
                // Turn off video
                button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                button.classList.add('bg-gray-600', 'hover:bg-gray-700');
                button.innerHTML = `<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414L3.707 2.293zm2.159 4.034A2 2 0 014 8v6a2 2 0 002 2h6c.352 0 .675-.091.96-.252l-8.094-8.094zM15 12.94l.894.894A1 1 0 0017 13V7a1 1 0 00-1.447-.894L13 7.382V8a2 2 0 01-2 2h-.94l4.94 4.94z" clip-rule="evenodd"></path></svg>`;
                
                // Stop video stream
                if (currentVideoStream && user === 'patient') {
                    currentVideoStream.getTracks().forEach(track => track.stop());
                    currentVideoStream = null;
                }
                videoElement.srcObject = null;
            } else {
                // Turn on video
                button.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                button.classList.add('bg-blue-600', 'hover:bg-blue-700');
                button.innerHTML = `<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path d="M2 6a2 2 0 012-2h6a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V6zM14.553 7.106A1 1 0 0014 8v4a1 1 0 00.553.894l2 1A1 1 0 0018 13V7a1 1 0 00-1.447-.894l-2 1z"></path></svg>`;
                
                // Start video stream for patient only (real camera)
                if (user === 'patient') {
                    try {
                        currentVideoStream = await navigator.mediaDevices.getUserMedia({ 
                            video: true, 
                            audio: false 
                        });
                        videoElement.srcObject = currentVideoStream;
                        videoElement.play();
                    } catch (error) {
                        console.error('Error accessing camera:', error);
                        addChatMessage('system', 'Could not access camera. Please check permissions.', 'System');
                        // Revert button state
                        button.classList.add('bg-gray-600', 'hover:bg-gray-700');
                        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        button.innerHTML = `<svg class="w-4 h-4 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414L3.707 2.293zm2.159 4.034A2 2 0 014 8v6a2 2 0 002 2h6c.352 0 .675-.091.96-.252l-8.094-8.094zM15 12.94l.894.894A1 1 0 0017 13V7a1 1 0 00-1.447-.894L13 7.382V8a2 2 0 01-2 2h-.94l4.94 4.94z" clip-rule="evenodd"></path></svg>`;
                    }
                } else {
                    // For provider, just show placeholder (simulated)
                    videoElement.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                }
            }
        }

        function shareScreen(user) {
            document.getElementById('sharedScreen').classList.remove('hidden');
            addChatMessage('system', `${user === 'provider' ? 'Dr. Johnson' : 'John'} is sharing their screen`, 'System');
        }

        function stopSharing() {
            document.getElementById('sharedScreen').classList.add('hidden');
            addChatMessage('system', 'Screen sharing stopped', 'System');
        }

        function requestHelp() {
            addChatMessage('system', 'John has requested technical assistance', 'System');
            addChatMessage('provider', "I see you need help. Let me assist you with that.", 'Dr. Johnson');
        }

        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message) {
                addChatMessage('patient', message, 'John');
                input.value = '';
                
                // Simulate provider response
                setTimeout(() => {
                    showTyping();
                    setTimeout(() => {
                        hideTyping();
                        const responses = [
                            "I understand. Let me check that for you.",
                            "That's good to hear. Any other concerns?",
                            "Thank you for that information.",
                            "Let's discuss this further.",
                            "I'll make a note of that in your file."
                        ];
                        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                        addChatMessage('provider', randomResponse, 'Dr. Johnson');
                    }, 2000);
                }, 1000);
            }
        }

        function addChatMessage(sender, message, name) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-message';
            
            const time = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
            
            let bgColor, initials;
            if (sender === 'provider') {
                bgColor = 'bg-blue-600';
                initials = 'DR';
            } else if (sender === 'patient') {
                bgColor = 'bg-green-600';
                initials = 'JD';
            } else {
                bgColor = 'bg-gray-600';
                initials = 'SYS';
            }
            
            const alignClass = sender === 'patient' ? 'flex-row-reverse' : '';
            const textAlign = sender === 'patient' ? 'text-right' : '';
            
            messageDiv.innerHTML = `
                <div class="flex items-start space-x-2 ${alignClass}">
                    <div class="w-6 h-6 ${bgColor} rounded-full flex items-center justify-center text-xs text-white">${initials}</div>
                    <div class="flex-1">
                        <div class="${bgColor} text-white p-2 rounded-lg text-sm ${textAlign}">
                            ${message}
                        </div>
                        <div class="text-gray-400 text-xs mt-1 ${textAlign}">${name} ‚Ä¢ ${time}</div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function showTyping() {
            document.getElementById('typingIndicator').classList.remove('hidden');
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function hideTyping() {
            document.getElementById('typingIndicator').classList.add('hidden');
        }

        function autoSaveNotes() {
            const notes = document.getElementById('providerNotes').value;
            const words = notes.trim().split(/\s+/).length;
            
            document.getElementById('wordCount').textContent = `${words} words`;
            document.getElementById('noteStatus').textContent = 'Auto-saved just now';
        }

        function saveNotes() {
            const notes = document.getElementById('providerNotes').value;
            console.log('Saving notes:', notes);
            document.getElementById('noteStatus').textContent = 'Manually saved';
            
            // Show success notification
            alert('Session notes saved successfully!');
        }

        function endSession() {
            if (confirm('Are you sure you want to end this telehealth session?')) {
                clearInterval(sessionTimer);
                clearInterval(vitalsInterval);
                
                // Show session summary
                const sessionTime = document.getElementById('sessionTimer').textContent;
                alert(`Session ended!\n\nDuration: ${sessionTime}\nNotes saved: Yes\nRecording: ${isRecording ? 'Saved' : 'Not recorded'}\nNext appointment scheduled.`);
                
                // In real app, would redirect to session summary page
                console.log('Session ended, redirecting to summary...');
            }
        }
    </script>
    
    <!-- Navigation Components -->
    <script src="enhanced-breadcrumbs.js"></script>
    <script src="back-to-home.js"></script>
</body>
</html>
