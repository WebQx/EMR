<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebQX‚Ñ¢ Patient Portal - Login</title>
    <link href="styles/output.css" rel="stylesheet">
</head>
<body class="portal-layout bg-gradient-medical min-h-screen flex items-center justify-center p-5">
    <!-- Login Container -->
    <div class="medical-card w-full max-w-md mx-auto overflow-hidden">
        <!-- Login Header -->
        <div class="bg-gradient-medical text-white p-8 text-center relative">
            <div class="absolute inset-0 bg-black bg-opacity-10"></div>
            <div class="relative z-10">
                <h1 class="text-3xl font-bold mb-2">üè• WebQX‚Ñ¢</h1>
                <p class="text-white text-opacity-90">Patient Portal Access</p>
            </div>
        </div>
        
        <!-- Login Form -->
        <form class="p-8 space-y-6" id="loginForm">
            <!-- Test Credentials Info -->
            <div class="bg-blue-50 border border-blue-200 rounded-medical p-4 text-sm">
                <h4 class="font-semibold text-medical-text mb-2">Test Credentials:</h4>
                <p class="mb-1">
                    <strong class="text-medical-text">Active User:</strong> 
                    <code class="bg-blue-100 text-blue-800 px-1 py-0.5 rounded text-xs">john.doe@example.com</code> / 
                    <code class="bg-blue-100 text-blue-800 px-1 py-0.5 rounded text-xs">password123</code>
                </p>
                <p>
                    <strong class="text-medical-text">Locked User:</strong> 
                    <code class="bg-blue-100 text-blue-800 px-1 py-0.5 rounded text-xs">locked@example.com</code> / 
                    <code class="bg-blue-100 text-blue-800 px-1 py-0.5 rounded text-xs">password123</code>
                </p>
            </div>

            <!-- Alert Message -->
            <div class="alert hidden" id="alertMessage"></div>
            
            <!-- Email Field -->
            <div class="form-group">
                <label for="email" class="form-label">Email Address</label>
                <input type="email" 
                       id="email" 
                       name="email" 
                       required 
                       class="form-input text-base">
                <div class="form-error hidden" id="emailError"></div>
            </div>
            
            <!-- Password Field -->
            <div class="form-group">
                <label for="password" class="form-label">Password</label>
                <input type="password" 
                       id="password" 
                       name="password" 
                       required 
                       class="form-input text-base">
                <div class="form-error hidden" id="passwordError"></div>
            </div>
            
            <!-- Login Button -->
            <button type="submit" 
                    class="btn-primary w-full py-3.5 text-base font-semibold hover-lift 
                           disabled:opacity-70 disabled:cursor-not-allowed disabled:transform-none
                           flex items-center justify-center gap-2" 
                    id="loginButton">
                <span class="loading-spinner hidden" id="loginSpinner"></span>
                <span id="loginButtonText">Sign In</span>
            </button>
            
            <!-- Forgot Password Link -->
            <div class="text-center">
                <a href="#" 
                   class="text-primary-500 hover:text-primary-600 text-sm font-medium
                          transition-colors underline-offset-4 hover:underline">
                    Forgot your password?
                </a>
            </div>
        </form>
    </div>

    <script>
        // Global variables
        let isLoading = false;

        // Initialize the form
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('loginForm');
            form.addEventListener('submit', handleLogin);
        });

        async function handleLogin(event) {
            event.preventDefault();
            
            if (isLoading) return;
            
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            // Clear previous errors
            clearErrors();
            
            // Validate inputs
            if (!validateInputs(email, password)) {
                return;
            }
            
            // Set loading state
            setLoadingState(true);
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Store authentication data
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    // Show success message
                    showAlert('Login successful! Redirecting...', 'success');
                    
                    // Redirect after a short delay
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1500);
                } else {
                    // Handle login error
                    showAlert(data.message || 'Login failed. Please try again.', 'error');
                    setLoadingState(false);
                }
            } catch (error) {
                console.error('Login error:', error);
                showAlert('Network error. Please check your connection and try again.', 'error');
                setLoadingState(false);
            }
        }

        function validateInputs(email, password) {
            let isValid = true;
            
            // Email validation
            if (!email) {
                showFieldError('email', 'Email address is required.');
                isValid = false;
            } else if (!isValidEmail(email)) {
                showFieldError('email', 'Please enter a valid email address.');
                isValid = false;
            }
            
            // Password validation
            if (!password) {
                showFieldError('password', 'Password is required.');
                isValid = false;
            } else if (password.length < 6) {
                showFieldError('password', 'Password must be at least 6 characters long.');
                isValid = false;
            }
            
            return isValid;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        function showFieldError(fieldName, message) {
            const field = document.getElementById(fieldName);
            const errorElement = document.getElementById(fieldName + 'Error');
            
            field.classList.add('border-red-500', 'bg-red-50');
            field.classList.remove('border-medical-subtle');
            
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
        }

        function clearErrors() {
            const fields = ['email', 'password'];
            fields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                const errorElement = document.getElementById(fieldName + 'Error');
                
                field.classList.remove('border-red-500', 'bg-red-50');
                field.classList.add('border-medical-subtle');
                
                errorElement.classList.add('hidden');
                errorElement.textContent = '';
            });
            
            hideAlert();
        }

        function showAlert(message, type = 'info') {
            const alert = document.getElementById('alertMessage');
            
            // Remove existing classes
            alert.classList.remove('hidden', 'bg-green-50', 'text-green-800', 'border-green-200',
                                   'bg-red-50', 'text-red-800', 'border-red-200',
                                   'bg-blue-50', 'text-blue-800', 'border-blue-200');
            
            // Add base classes
            alert.classList.add('p-3', 'rounded-medical', 'border', 'text-sm', 'font-medium');
            
            // Add type-specific classes
            switch (type) {
                case 'success':
                    alert.classList.add('bg-green-50', 'text-green-800', 'border-green-200');
                    break;
                case 'error':
                    alert.classList.add('bg-red-50', 'text-red-800', 'border-red-200');
                    break;
                default:
                    alert.classList.add('bg-blue-50', 'text-blue-800', 'border-blue-200');
            }
            
            alert.textContent = message;
        }

        function hideAlert() {
            const alert = document.getElementById('alertMessage');
            alert.classList.add('hidden');
        }

        function setLoadingState(loading) {
            isLoading = loading;
            const button = document.getElementById('loginButton');
            const spinner = document.getElementById('loginSpinner');
            const buttonText = document.getElementById('loginButtonText');
            
            if (loading) {
                button.disabled = true;
                spinner.classList.remove('hidden');
                buttonText.textContent = 'Signing In...';
            } else {
                button.disabled = false;
                spinner.classList.add('hidden');
                buttonText.textContent = 'Sign In';
            }
        }

        // Enhanced accessibility: Form submission on Enter key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !isLoading) {
                event.preventDefault();
                document.getElementById('loginForm').dispatchEvent(new Event('submit'));
            }
        });

        // Auto-clear errors when user starts typing
        ['email', 'password'].forEach(fieldName => {
            document.getElementById(fieldName).addEventListener('input', function() {
                const field = this;
                const errorElement = document.getElementById(fieldName + 'Error');
                
                if (!errorElement.classList.contains('hidden')) {
                    field.classList.remove('border-red-500', 'bg-red-50');
                    field.classList.add('border-medical-subtle');
                    errorElement.classList.add('hidden');
                }
            });
        });
    </script>
</body>
</html>