<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebQX SSO Admin Console</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e1e5e9;
        }
        
        .card h2 {
            color: #333;
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-healthy { background-color: #34d399; }
        .status-warning { background-color: #fbbf24; }
        .status-error { background-color: #f87171; }
        
        .provider-list {
            list-style: none;
        }
        
        .provider-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .provider-item:last-child {
            border-bottom: none;
        }
        
        .provider-name {
            font-weight: 500;
        }
        
        .provider-status {
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-enabled {
            background-color: #d1fae5;
            color: #065f46;
        }
        
        .status-disabled {
            background-color: #fee2e2;
            color: #991b1b;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .stat-card {
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            background: #f8fafc;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 0.875rem;
        }
        
        .btn {
            background: #667eea;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn:hover {
            background: #5a67d8;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }
        
        .btn-secondary:hover {
            background: #cbd5e1;
        }
        
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .alert-warning {
            background: #fef3cd;
            border: 1px solid #fde68a;
            color: #92400e;
        }
        
        .alert-success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
        }
        
        .config-section {
            margin-top: 2rem;
        }
        
        .config-section h3 {
            margin-bottom: 1rem;
            color: #374151;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-checkbox {
            margin-right: 0.5rem;
        }
        
        .tabs {
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 2rem;
        }
        
        .tab {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            color: #6b7280;
            text-decoration: none;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .tab.active,
        .tab:hover {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê WebQX SSO Admin Console</h1>
        <p>Single Sign-On Configuration & Monitoring Dashboard</p>
    </div>

    <div class="container">
        <div id="loading" class="loading">
            <p>Loading SSO configuration...</p>
        </div>

        <div id="content" style="display: none;">
            <div class="tabs">
                <a href="#overview" class="tab active" onclick="showTab('overview')">Overview</a>
                <a href="#providers" class="tab" onclick="showTab('providers')">Providers</a>
                <a href="#sessions" class="tab" onclick="showTab('sessions')">Sessions</a>
                <a href="#audit" class="tab" onclick="showTab('audit')">Audit Logs</a>
                <a href="#config" class="tab" onclick="showTab('config')">Configuration</a>
            </div>

            <!-- Overview Tab -->
            <div id="overview-tab" class="tab-content">
                <div class="dashboard-grid">
                    <div class="card">
                        <h2>üè• System Status</h2>
                        <div id="system-status">
                            <div style="margin-bottom: 1rem;">
                                <span class="status-indicator status-healthy"></span>
                                <strong>SSO Service:</strong> <span id="sso-status">Healthy</span>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <span class="status-indicator status-healthy"></span>
                                <strong>Session Manager:</strong> <span id="session-status">Active</span>
                            </div>
                            <div>
                                <span class="status-indicator status-healthy"></span>
                                <strong>Audit Logger:</strong> <span id="audit-status">Running</span>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>üìä Quick Stats</h2>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="active-sessions">--</div>
                                <div class="stat-label">Active Sessions</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="total-users">--</div>
                                <div class="stat-label">Total Users</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="enabled-providers">--</div>
                                <div class="stat-label">Providers</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <h2>üîß Enabled Providers</h2>
                        <ul class="provider-list" id="provider-overview">
                            <!-- Populated by JavaScript -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Providers Tab -->
            <div id="providers-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <h2>OAuth2 Providers</h2>
                    <div id="oauth2-providers">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <h2>SAML Providers</h2>
                    <div id="saml-providers">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Sessions Tab -->
            <div id="sessions-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <h2>Session Statistics</h2>
                    <div id="session-stats">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Audit Tab -->
            <div id="audit-tab" class="tab-content" style="display: none;">
                <div class="card">
                    <h2>Recent Audit Events</h2>
                    <div id="audit-logs">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Configuration Tab -->
            <div id="config-tab" class="tab-content" style="display: none;">
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Configuration Note:</strong> 
                    SSO provider configuration is managed through environment variables. 
                    Changes require server restart to take effect.
                </div>

                <div class="card">
                    <h2>Configuration Status</h2>
                    <div id="config-status">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <div class="card" style="margin-top: 2rem;">
                    <h2>Environment Variables Guide</h2>
                    <div class="config-section">
                        <h3>OAuth2 Configuration</h3>
                        <p>Configure OAuth2 providers by setting these environment variables:</p>
                        <ul style="margin: 1rem 0; padding-left: 2rem;">
                            <li><code>GOOGLE_CLIENT_ID</code>, <code>GOOGLE_CLIENT_SECRET</code></li>
                            <li><code>MICROSOFT_CLIENT_ID</code>, <code>MICROSOFT_CLIENT_SECRET</code></li>
                            <li><code>OKTA_CLIENT_ID</code>, <code>OKTA_CLIENT_SECRET</code>, <code>OKTA_DOMAIN</code></li>
                        </ul>
                    </div>

                    <div class="config-section">
                        <h3>SAML Configuration</h3>
                        <p>Configure SAML providers by setting these environment variables:</p>
                        <ul style="margin: 1rem 0; padding-left: 2rem;">
                            <li><code>SAML_AZURE_ENTITY_ID</code>, <code>SAML_AZURE_SSO_URL</code>, <code>SAML_AZURE_CERTIFICATE</code></li>
                            <li><code>SAML_ONELOGIN_ENTITY_ID</code>, <code>SAML_ONELOGIN_SSO_URL</code>, <code>SAML_ONELOGIN_CERTIFICATE</code></li>
                            <li><code>SAML_PING_ENTITY_ID</code>, <code>SAML_PING_SSO_URL</code>, <code>SAML_PING_CERTIFICATE</code></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentTab = 'overview';
        let ssoData = null;

        // Initialize the dashboard
        async function initDashboard() {
            try {
                // Load SSO configuration and stats
                const [configResponse, statsResponse] = await Promise.all([
                    fetch('/api/sso/config/status'),
                    fetch('/api/sso/admin/stats').catch(() => ({ ok: false })) // Graceful fallback
                ]);

                const config = await configResponse.json();
                ssoData = { config };

                if (statsResponse.ok) {
                    ssoData.stats = await statsResponse.json();
                }

                populateDashboard();
            } catch (error) {
                console.error('Failed to load SSO data:', error);
                showError('Failed to load SSO configuration. Please check your connection and permissions.');
            } finally {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';
            }
        }

        // Populate dashboard with data
        function populateDashboard() {
            if (!ssoData) return;

            // Update system status
            updateSystemStatus();
            
            // Update provider overview
            updateProviderOverview();
            
            // Update stats if available
            if (ssoData.stats) {
                updateStats();
            }
        }

        // Update system status indicators
        function updateSystemStatus() {
            const config = ssoData.config;
            
            document.getElementById('sso-status').textContent = config.initialized ? 'Healthy' : 'Not Initialized';
            document.getElementById('session-status').textContent = config.features.sessionManagement ? 'Active' : 'Inactive';
            document.getElementById('audit-status').textContent = config.features.auditLogging ? 'Running' : 'Disabled';
        }

        // Update provider overview
        function updateProviderOverview() {
            const config = ssoData.config;
            const providerList = document.getElementById('provider-overview');
            
            providerList.innerHTML = '';

            // OAuth2 providers
            config.oauth2.providers.forEach(provider => {
                const item = document.createElement('li');
                item.className = 'provider-item';
                item.innerHTML = `
                    <div>
                        <span class="provider-name">OAuth2: ${provider.charAt(0).toUpperCase() + provider.slice(1)}</span>
                    </div>
                    <span class="provider-status status-enabled">Enabled</span>
                `;
                providerList.appendChild(item);
            });

            // SAML providers
            config.saml.providers.forEach(provider => {
                const item = document.createElement('li');
                item.className = 'provider-item';
                item.innerHTML = `
                    <div>
                        <span class="provider-name">SAML: ${provider.charAt(0).toUpperCase() + provider.slice(1)}</span>
                    </div>
                    <span class="provider-status status-enabled">Enabled</span>
                `;
                providerList.appendChild(item);
            });

            if (config.oauth2.providers.length === 0 && config.saml.providers.length === 0) {
                providerList.innerHTML = '<li class="provider-item">No providers configured</li>';
            }

            // Update enabled providers count
            const totalProviders = config.oauth2.providers.length + config.saml.providers.length;
            document.getElementById('enabled-providers').textContent = totalProviders;
        }

        // Update statistics
        function updateStats() {
            const stats = ssoData.stats;
            
            if (stats.sessions) {
                document.getElementById('active-sessions').textContent = stats.sessions.totalActiveSessions || 0;
                document.getElementById('total-users').textContent = stats.sessions.totalUsers || 0;
            }
        }

        // Show tab
        function showTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.style.display = 'none');

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + '-tab').style.display = 'block';
            
            // Add active class to selected tab
            event.target.classList.add('active');
            
            currentTab = tabName;

            // Load tab-specific data if needed
            if (tabName === 'audit' && ssoData && ssoData.stats) {
                populateAuditTab();
            } else if (tabName === 'sessions' && ssoData && ssoData.stats) {
                populateSessionsTab();
            } else if (tabName === 'providers') {
                populateProvidersTab();
            } else if (tabName === 'config') {
                populateConfigTab();
            }
        }

        // Populate audit tab
        function populateAuditTab() {
            const auditContainer = document.getElementById('audit-logs');
            const stats = ssoData.stats;

            if (stats.audit) {
                auditContainer.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${stats.audit.totalEvents || 0}</div>
                            <div class="stat-label">Total Events (24h)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.audit.successfulLogins || 0}</div>
                            <div class="stat-label">Successful Logins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.audit.failedLogins || 0}</div>
                            <div class="stat-label">Failed Logins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.audit.uniqueUsers || 0}</div>
                            <div class="stat-label">Unique Users</div>
                        </div>
                    </div>
                `;

                if (stats.security && stats.security.alerts > 0) {
                    auditContainer.innerHTML += `
                        <div class="alert alert-warning" style="margin-top: 2rem;">
                            <strong>‚ö†Ô∏è Security Alert:</strong> ${stats.security.alerts} security events detected in the last 24 hours.
                        </div>
                    `;
                }
            } else {
                auditContainer.innerHTML = '<p>Audit statistics not available. Admin permissions required.</p>';
            }
        }

        // Populate sessions tab
        function populateSessionsTab() {
            const sessionContainer = document.getElementById('session-stats');
            const stats = ssoData.stats;

            if (stats.sessions) {
                sessionContainer.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${stats.sessions.totalActiveSessions || 0}</div>
                            <div class="stat-label">Active Sessions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.sessions.totalUsers || 0}</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.sessions.averageSessionAge || 0}</div>
                            <div class="stat-label">Avg Session Age (min)</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${stats.sessions.upcomingExpirations || 0}</div>
                            <div class="stat-label">Expiring Soon</div>
                        </div>
                    </div>
                `;

                // Add provider breakdown if available
                if (stats.sessions.sessionsByProvider) {
                    let providerHtml = '<h3 style="margin-top: 2rem; margin-bottom: 1rem;">Sessions by Provider</h3><ul class="provider-list">';
                    for (const [provider, count] of Object.entries(stats.sessions.sessionsByProvider)) {
                        providerHtml += `
                            <li class="provider-item">
                                <span class="provider-name">${provider.charAt(0).toUpperCase() + provider.slice(1)}</span>
                                <span class="provider-status status-enabled">${count} sessions</span>
                            </li>
                        `;
                    }
                    providerHtml += '</ul>';
                    sessionContainer.innerHTML += providerHtml;
                }
            } else {
                sessionContainer.innerHTML = '<p>Session statistics not available. Admin permissions required.</p>';
            }
        }

        // Populate providers tab
        function populateProvidersTab() {
            const config = ssoData.config;
            
            // OAuth2 providers
            const oauth2Container = document.getElementById('oauth2-providers');
            if (config.oauth2.providers.length > 0) {
                let oauth2Html = '<ul class="provider-list">';
                config.oauth2.providers.forEach(provider => {
                    oauth2Html += `
                        <li class="provider-item">
                            <div>
                                <span class="provider-name">${provider.charAt(0).toUpperCase() + provider.slice(1)}</span>
                                <br><small>OAuth2 Authentication Provider</small>
                            </div>
                            <span class="provider-status status-enabled">Configured</span>
                        </li>
                    `;
                });
                oauth2Html += '</ul>';
                oauth2Container.innerHTML = oauth2Html;
            } else {
                oauth2Container.innerHTML = '<p>No OAuth2 providers configured.</p>';
            }

            // SAML providers
            const samlContainer = document.getElementById('saml-providers');
            if (config.saml.providers.length > 0) {
                let samlHtml = '<ul class="provider-list">';
                config.saml.providers.forEach(provider => {
                    samlHtml += `
                        <li class="provider-item">
                            <div>
                                <span class="provider-name">${provider.charAt(0).toUpperCase() + provider.slice(1)}</span>
                                <br><small>SAML Authentication Provider</small>
                            </div>
                            <span class="provider-status status-enabled">Configured</span>
                        </li>
                    `;
                });
                samlHtml += '</ul>';
                samlContainer.innerHTML = samlHtml;
            } else {
                samlContainer.innerHTML = '<p>No SAML providers configured.</p>';
            }
        }

        // Populate config tab
        function populateConfigTab() {
            const configContainer = document.getElementById('config-status');
            const config = ssoData.config;

            configContainer.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${config.oauth2.enabled ? '‚úÖ' : '‚ùå'}</div>
                        <div class="stat-label">OAuth2 Enabled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${config.saml.enabled ? '‚úÖ' : '‚ùå'}</div>
                        <div class="stat-label">SAML Enabled</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${config.features.sessionManagement ? '‚úÖ' : '‚ùå'}</div>
                        <div class="stat-label">Session Management</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${config.features.rbac ? '‚úÖ' : '‚ùå'}</div>
                        <div class="stat-label">RBAC</div>
                    </div>
                </div>
            `;
        }

        // Show error message
        function showError(message) {
            const content = document.getElementById('content');
            content.innerHTML = `
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Error:</strong> ${message}
                </div>
                <button class="btn" onclick="location.reload()">Retry</button>
            `;
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>