<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenEMR Launch Demo</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f766e 0%, #0891b2 50%, #164e63 100%);
            min-height: 100vh;
            color: white;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 30px;
            backdrop-filter: blur(10px);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #fff;
        }
        .demo-section {
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .launch-button {
            background: linear-gradient(135deg, #059669, #0d9488);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 10px;
            transition: all 0.3s ease;
            min-width: 200px;
        }
        .launch-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .launch-button:active {
            transform: translateY(0);
        }
        .status-panel {
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #10b981; }
        .status-warning { background: #f59e0b; }
        .status-error { background: #ef4444; }
        .status-info { background: #3b82f6; }
        .config-display {
            background: rgba(0,0,0,0.2);
            border-radius: 6px;
            padding: 12px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        .demo-mode-banner {
            background: linear-gradient(90deg, #f59e0b, #d97706);
            color: white;
            text-align: center;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- Demo Mode Banner -->
    <div class="demo-mode-banner">
        ğŸ­ DEMO MODE ACTIVE - OpenEMR Integration Testing Environment
    </div>

    <div class="container">
        <h1>ğŸ¥ OpenEMR Launch Demo</h1>
        
        <div class="demo-section">
            <h3>ğŸ”§ System Status</h3>
            <div id="statusDisplay">
                <div><span class="status-indicator status-info"></span>Initializing system...</div>
            </div>
        </div>

        <div class="demo-section">
            <h3>ğŸš€ OpenEMR Launch Options</h3>
            <p>Test different OpenEMR launch modes and modules:</p>
            
            <div class="button-group">
                <button class="launch-button" onclick="launchOpenEMR('modal', 'patient_management')">
                    ğŸ¥ Patient Management (Modal)
                </button>
                <button class="launch-button" onclick="launchOpenEMR('window', 'appointments')">
                    ğŸ“… Appointments (Window)
                </button>
                <button class="launch-button" onclick="launchOpenEMR('modal', 'clinical_data')">
                    ğŸ“Š Clinical Data (Modal)
                </button>
                <button class="launch-button" onclick="launchOpenEMR('embed', 'patient_search')">
                    ğŸ” Patient Search (Embed)
                </button>
            </div>

            <div class="button-group">
                <button class="launch-button" onclick="testBasicLaunch()">
                    âš¡ Basic Launch Test
                </button>
                <button class="launch-button" onclick="testConfigLoad()">
                    âš™ï¸ Test Configuration
                </button>
                <button class="launch-button" onclick="resetSystem()">
                    ğŸ”„ Reset System
                </button>
            </div>
        </div>

        <div class="demo-section">
            <h3>ğŸ“‹ Activity Log</h3>
            <div id="activityLog" class="status-panel">System starting up...\n</div>
        </div>

        <div class="demo-section">
            <h3>âš™ï¸ Current Configuration</h3>
            <div id="configDisplay" class="config-display">Loading configuration...</div>
        </div>

        <div class="demo-section">
            <h3>ğŸ” Debug Information</h3>
            <div id="debugInfo" class="config-display">
                <div>Authentication Status: <span id="authStatus">Checking...</span></div>
                <div>Launcher Status: <span id="launcherStatus">Loading...</span></div>
                <div>Config Status: <span id="configStatus">Loading...</span></div>
                <div>Demo Mode: <span id="demoModeStatus">âœ… Active</span></div>
            </div>
        </div>
    </div>

    <!-- Demo Authentication (loads first) -->
    <script src="./demo-auth.js"></script>
    
    <!-- OpenEMR Integration -->
    <script src="./openemr-config.js"></script>
    <script src="./openemr-launcher.js"></script>

    <script>
        // Enhanced logging and testing functions
        let logCount = 0;
        
        function log(message, type = 'info') {
            logCount++;
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('activityLog');
            const statusIcon = {
                'info': 'ğŸ”µ',
                'success': 'âœ…',
                'warning': 'âš ï¸',
                'error': 'âŒ'
            }[type] || 'â„¹ï¸';
            
            const logMessage = `[${timestamp}] ${statusIcon} ${message}\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[OpenEMR Demo] ${message}`);
        }

        function updateStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (element) {
                const statusIcon = {
                    'info': 'ğŸ”µ',
                    'success': 'âœ…',
                    'warning': 'âš ï¸',
                    'error': 'âŒ'
                }[type] || 'â„¹ï¸';
                element.textContent = `${statusIcon} ${message}`;
            }
        }

        async function launchOpenEMR(mode, module) {
            log(`Starting OpenEMR launch: ${module} in ${mode} mode`, 'info');
            
            try {
                if (!window.openEMRLauncher) {
                    throw new Error('OpenEMR Launcher not available');
                }

                updateStatus('launcherStatus', 'Launching...', 'info');

                const result = await window.openEMRLauncher.launchOpenEMR({
                    mode: mode,
                    module: module,
                    context: 'demo_portal'
                });

                if (result.success) {
                    log(`âœ… OpenEMR ${module} launched successfully in ${mode} mode`, 'success');
                    log(`Action: ${result.action}`, 'info');
                    updateStatus('launcherStatus', 'Launch Successful', 'success');
                } else {
                    throw new Error(result.error || 'Unknown launch error');
                }

            } catch (error) {
                log(`âŒ Launch failed: ${error.message}`, 'error');
                updateStatus('launcherStatus', 'Launch Failed', 'error');
                
                // Show error details
                log(`Error details: ${error.stack || 'No stack trace available'}`, 'error');
            }
        }

        async function testBasicLaunch() {
            log('ğŸ§ª Running basic launch test...', 'info');
            
            try {
                // Test launcher availability
                if (window.openEMRLauncher) {
                    log('âœ… OpenEMR Launcher is available', 'success');
                    
                    // Test demo mode detection
                    if (window.openEMRLauncher.isDemoMode) {
                        const isDemo = window.openEMRLauncher.isDemoMode();
                        log(`Demo Mode: ${isDemo ? 'Active' : 'Inactive'}`, isDemo ? 'success' : 'warning');
                    }
                    
                    // Test basic launch
                    await launchOpenEMR('modal', 'patient_management');
                    
                } else {
                    throw new Error('OpenEMR Launcher not found');
                }
            } catch (error) {
                log(`âŒ Basic test failed: ${error.message}`, 'error');
            }
        }

        function testConfigLoad() {
            log('ğŸ”§ Testing configuration load...', 'info');
            
            try {
                if (window.openemrConfig) {
                    log('âœ… OpenEMR Config loaded successfully', 'success');
                    updateStatus('configStatus', 'Loaded', 'success');
                    
                    // Display configuration
                    document.getElementById('configDisplay').textContent = JSON.stringify(window.openemrConfig, null, 2);
                } else {
                    throw new Error('OpenEMR Config not found');
                }

                if (window.openEMRLauncher && window.openEMRLauncher.config) {
                    log('âœ… Launcher configuration available', 'success');
                    log(`Base URL: ${window.openEMRLauncher.config.baseUrl}`, 'info');
                    log(`Client ID: ${window.openEMRLauncher.config.clientId}`, 'info');
                } else {
                    log('âš ï¸ Launcher configuration not yet available', 'warning');
                }
            } catch (error) {
                log(`âŒ Config test failed: ${error.message}`, 'error');
                updateStatus('configStatus', 'Failed', 'error');
            }
        }

        function resetSystem() {
            log('ğŸ”„ Resetting system...', 'info');
            
            // Clear logs
            document.getElementById('activityLog').textContent = 'System reset...\n';
            logCount = 0;
            
            // Reset status indicators
            updateStatus('authStatus', 'Checking...', 'info');
            updateStatus('launcherStatus', 'Resetting...', 'info');
            updateStatus('configStatus', 'Resetting...', 'info');
            
            // Reinitialize
            setTimeout(() => {
                initializeDemo();
            }, 1000);
        }

        function checkAuthentication() {
            const authToken = localStorage.getItem('providerAuthToken');
            const userInfo = localStorage.getItem('providerUser');
            
            if (authToken && userInfo) {
                try {
                    const user = JSON.parse(userInfo);
                    log(`âœ… Authentication active: ${user.name}`, 'success');
                    updateStatus('authStatus', `Authenticated: ${user.name}`, 'success');
                    return true;
                } catch (error) {
                    log('âŒ Authentication data corrupted', 'error');
                    updateStatus('authStatus', 'Authentication Error', 'error');
                    return false;
                }
            } else {
                log('âš ï¸ No authentication found', 'warning');
                updateStatus('authStatus', 'Not Authenticated', 'warning');
                return false;
            }
        }

        function initializeDemo() {
            log('ğŸ­ Initializing OpenEMR Demo Launch Environment...', 'info');
            
            // Check authentication
            setTimeout(() => {
                checkAuthentication();
            }, 500);
            
            // Check configuration
            setTimeout(() => {
                testConfigLoad();
            }, 1000);
            
            // Check launcher
            setTimeout(() => {
                if (window.openEMRLauncher) {
                    log('âœ… OpenEMR Launcher initialized', 'success');
                    updateStatus('launcherStatus', 'Ready', 'success');
                } else {
                    log('âš ï¸ OpenEMR Launcher not yet available', 'warning');
                    updateStatus('launcherStatus', 'Loading...', 'warning');
                }
            }, 1500);
            
            log('ğŸš€ Demo environment ready for testing', 'success');
        }

        // Auto-initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(initializeDemo, 1000);
        });

        // Global error handler
        window.addEventListener('error', (event) => {
            log(`ğŸ’¥ JavaScript Error: ${event.error?.message || event.message}`, 'error');
        });
    </script>
</body>
</html>
